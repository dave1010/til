<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="/assets/css/styles.css">
  </head>
  <body>
    <header>
        <h1><a href="/">Dave Hulbert's Today I Learned (TIL)</a></h1>
    </header>

    <main>
        <hr>
        <section>
            <h1>Notes on designing through mocking</h1>
<p>date:   2014-10-30 21:44:07</p>
<p>My notes on Everzet's talk &quot;Design how your objects talk through mocking&quot; at PHPNW14</p>
<ul>
<li>Everzet's <a href="http://www.slideshare.net/everzet/design-how-your-objects-talk-through-mocking">Original slide deck</a></li>
<li>Code sample here are using <a href="https://github.com/phpspec/prophecy">Prophecy</a> to create test doubles</li>
</ul>
<h1>Different test doubles: Mocks, stubs, spies, dummies and fakes</h1>
<h2>Dummy</h2>
<ul>
<li>Don't care about. Passed around for typehinting.</li>
<li>No behaviour</li>
</ul>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">Foo</span> <span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">__construct</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Dummy</span> <span class="token variable">$dummy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token punctuation">}</span>
<span class="token keyword">new</span> <span class="token class-name">Foo</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Prophecy<span class="token punctuation">\</span>Prophet</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">prophesize</span><span class="token punctuation">(</span><span class="token class-name static-context">Dumnmy</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">reveal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h2>Stub</h2>
<ul>
<li>Has (basic) behaviour but no expectations (i.e. injects input into SUT but never handles output)</li>
<li>Dummy that you call a method on</li>
<li>Promises it will always return the same thing (<code>willReturn()</code>)</li>
<li>Doesn't have to be called</li>
</ul>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">baz</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Stub</span> <span class="token variable">$stub</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token variable">$stub</span><span class="token operator">-></span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'bar'</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token variable">$stub</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Prophecy<span class="token punctuation">\</span>Prophet</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">prophesize</span><span class="token punctuation">(</span><span class="token class-name static-context">Stub</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$stub</span><span class="token operator">-></span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">wilLReturn</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'bar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">baz</span><span class="token punctuation">(</span><span class="token variable">$stub</span><span class="token operator">-></span><span class="token function">reveal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h2>Mock</h2>
<ul>
<li>Define predictions (<code>shouldBeCalled()</code>), not promises</li>
<li>Verifies input from SUT</li>
</ul>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Mock</span> <span class="token variable">$mock</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token variable">$mock</span><span class="token operator">-></span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token variable">$prophet</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Prophecy<span class="token punctuation">\</span>Prophet</span><span class="token punctuation">;</span>
<span class="token variable">$mock</span> <span class="token operator">=</span> <span class="token variable">$prophet</span><span class="token operator">-></span><span class="token function">prophesize</span><span class="token punctuation">(</span><span class="token class-name static-context">Mock</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$mock</span><span class="token operator">-></span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">shouldBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token variable">$mock</span><span class="token operator">-></span><span class="token function">reveal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$prophet</span><span class="token operator">-></span><span class="token function">checkPredictions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h2>Spy</h2>
<ul>
<li>Records behaviour</li>
<li>Assertions happen aftwerwards (<code>shouldHaveBeenCalled()</code>)</li>
</ul>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">function</span> <span class="token function-definition function">foo</span><span class="token punctuation">(</span><span class="token class-name type-declaration">Spy</span> <span class="token variable">$spy</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token variable">$spy</span><span class="token operator">-></span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token variable">$spy</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name class-name-fully-qualified"><span class="token punctuation">\</span>Prophecy<span class="token punctuation">\</span>Prophet</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">prophesize</span><span class="token punctuation">(</span><span class="token class-name static-context">Spy</span><span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">foo</span><span class="token punctuation">(</span><span class="token variable">$spy</span><span class="token operator">-></span><span class="token function">reveal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$spy</span><span class="token operator">-></span><span class="token function">bar</span><span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">shouldHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></code></pre>
<h2>Fake</h2>
<ul>
<li>Return data depending on input</li>
<li>Used to simplify a dependency. E.g. web service, DB, repository</li>
<li>Used to isolate SUT</li>
</ul>
<pre class="language-php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">interface</span> <span class="token class-name-definition class-name">WebServiceInterface</span> <span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">strtoupper</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">RealWebService</span> <span class="token keyword">implements</span> <span class="token class-name">WebServiceInterface</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">strtoupper</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'api.com/strtoupper/'</span><span class="token operator">.</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name-definition class-name">FakeWebService</span> <span class="token keyword">implements</span> <span class="token class-name">WebServiceInterface</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function-definition function">strtoupper</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token function">strtoupper</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></code></pre>
<h1>How mocking helps you follow SOLID principles</h1>
<ul>
<li>lots of mocks means <em>SRP</em> violation. Don't fake parts of objects: decouple them</li>
<li>Duplication in tests means <em>OCP</em> violation</li>
<li>Refused bequest: when you call a method that you didn't expect and there's an interface that covers the method. Means drivers are incompatible.</li>
<li><em>LSP</em>: if objects implement the same interface then they should have the same behaviour. To fix, make a new interface and an adaptor</li>
<li><em>ISP</em> violation. Don't force objects to have methods that aren't in a test. If a test doesn't use a whole interface then split the interface</li>
<li><em>DIP</em>. Don't mock things you don't own. Don't test code you don't own, that's an integration test.</li>
</ul>
<h1>Testing outcomes vs testing communication between objects</h1>
<ul>
<li>Exposing outcomes vs exposing communications. Both. Tests usually expose outcomes but communication is important too.</li>
<li>Exposing outcomes forces you to create meaningless getters just for tests</li>
<li>Test outcomes when just 1 object. Test communication when multiple.</li>
<li>Exposing communication creates more objects</li>
<li>Don't use mocks for isolation, that's not what they're for (that's fakes)</li>
<li>Messaging is more important than state</li>
</ul>
<h2>Summary</h2>
<ul>
<li>TDD based on communication fixes SOLID violations before they happen</li>
</ul>

        </section>

        <hr>

        <footer>
            <p>
                &copy; Dave Hulbert<br><a href="/">Home</a>
                    |
                    <a href="https://github.com/dave1010/til/blob/main/./tdd/2014-10-30-designing-through-mocking.md" target="_blank">Edit this page on GitHub</a></p>
        </footer>
    </main>
  </body>
</html>
