<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="/assets/css/styles.css">
  </head>
  <body>
    <header>
        <h1><a href="/">Dave Hulbert's Today I Learned (TIL)</a></h1>
    </header>

    <main>
        <hr>
        <section>
            <h1>Dokku Setup</h1>
<p>This is an overview of how to get a server set up running Dokku, with wildcard domains.</p>
<p>Out the box Dokku image from DigitalOcean: https://marketplace.digitalocean.com/apps/dokku</p>
<h2>Locally</h2>
<p>Git setup:</p>
<pre class="language-bash"><code class="language-bash"><span class="token assign-left variable">DOKKU_HOST</span><span class="token operator">=</span>ssh.example.com
<span class="token assign-left variable">APP_NAME</span><span class="token operator">=</span>amazing-app

<span class="token function">git</span> remote <span class="token function">add</span> dokku dokku@<span class="token variable">$DOKKU_HOST</span><span class="token builtin class-name">:</span><span class="token variable">$APP_NAME</span></code></pre>
<h2>Project structure</h2>
<h3>PHP</h3>
<p>Symfony defaults to <code>./public</code>.</p>
<pre class="language-bash"><code class="language-bash"><span class="token function">composer</span> require symfony/apache-pack
<span class="token builtin class-name">echo</span> <span class="token string">'web: heroku-php-apache2 public/'</span> <span class="token operator">></span> Procfile</code></pre>
<h2>Deployment</h2>
<pre class="language-bash"><code class="language-bash"><span class="token function">git</span> push dokku main</code></pre>
<h2>Setting up a Dokku host</h2>
<h3>Prerequesits</h3>
<ol>
<li>Install Dokku on a server. Eg <a href="https://marketplace.digitalocean.com/apps/dokku">DigitalOcean 1-click</a>.</li>
<li>Add a wildcard A record domain. If you're using Cloudflare then add proxying.</li>
</ol>
<pre class="language-bash"><code class="language-bash"><span class="token function">ssh</span> root@<span class="token variable">$DOKKU_HOST</span>
<span class="token assign-left variable">YOUR_NAME</span><span class="token operator">=</span>dave
<span class="token assign-left variable">DOMAIN</span><span class="token operator">=</span>example.com

<span class="token comment"># add your ssh key</span>
dokku ssh-keys:add admin_<span class="token variable">$YOUR_NAME</span>

<span class="token comment"># enable wildcard subdomains on $DOMAIN</span>
dokku domains:set-global <span class="token variable">$DOMAIN</span>

<span class="token comment"># postgres support</span>
dokku plugin:install https://github.com/dokku/dokku-postgres.git
</code></pre>
<h3>Creating and managing a new app</h3>
<pre class="language-bash"><code class="language-bash"><span class="token assign-left variable">APP_NAME</span><span class="token operator">=</span>amazing-app

dokku apps:create <span class="token variable">$APP_NAME</span>

<span class="token comment"># shouldn't be needed</span>
dokku domains:add <span class="token variable">$APP_NAME</span> <span class="token variable">$APP_NAME</span><span class="token builtin class-name">.</span><span class="token variable">$DOMAIN</span>

<span class="token comment"># DB</span>
dokku postgres:create db_<span class="token variable">$APP_NAME</span>
dokku postgres:link db_<span class="token variable">$APP_NAME</span> <span class="token variable">$APP_NAME</span>
<span class="token comment"># check env is set</span>
dokku config:get <span class="token variable">$APP_NAME</span> DATABASE_URL

<span class="token comment"># set env vars</span>
dokku config:set <span class="token variable">$APP_NAME</span> <span class="token assign-left variable">APP_ENV</span><span class="token operator">=</span>prod</code></pre>
<p>Once deployed, you may need to set up the app</p>
<pre class="language-bash"><code class="language-bash">dokku enter <span class="token variable">$APP_NAME</span> doctrine:schema:create</code></pre>
<h2>Debugging</h2>
<pre class="language-bash"><code class="language-bash"><span class="token comment"># interactive shell</span>
dokku enter <span class="token variable">$APP_NAME</span>

<span class="token comment"># tail logs</span>
dokku logs <span class="token parameter variable">-t</span> <span class="token variable">$APP_NAME</span></code></pre>

        </section>

        <hr>

        <footer>
            <p>
                &copy; Dave Hulbert<br><a href="/">Home</a>
                    |
                    <a href="https://github.com/dave1010/til/blob/main/./docker/dokku-setup.md" target="_blank">Edit this page on GitHub</a></p>
        </footer>
    </main>
  </body>
</html>
