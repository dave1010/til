<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <link rel="stylesheet" href="/assets/css/styles.css">
  </head>
  <body>
    <header>
        <a href="/">Dave Hulbert's Today I Learned (TIL)</a>
    </header>

    <main>
        <section>
            <h1>Patching Transitive Dependency Vulnerabilities in PHP Projects with Composer</h1>
<p>We encountered a challenge recently with a security vulnerability in a transitive dependency.
This was where our project depended on a library (let's call it <code>acme-corp/foo</code>),  which then depended on another library (let's call it <code>symfony/http-client</code>).</p>
<p>So we had this structure:</p>
<pre><code>our project
    depends on: acme-corp/foo
        depends on: symfony/http-client
</code></pre>
<p>When we get a vulnerability report (eg from Packagist, <a href="https://github.com/fabpot/local-php-security-checker">local-php-security-checker</a> or running <code>composer audit</code>)
then our normal step is to do a <code>composer update</code> and upgrade to a patched version.</p>
<p>This is normally easy to do but in this case, acme-corp/foo was depending on a specific vulnerable version of symfony/http-client.
acme-corp/foo was crucial to the project, but it hadn't been updated to address the newly discovered vulnerability.
Faced with the need to protect the application while awaiting an official update, we explored several options.</p>
<ul>
<li>contribute a fix to acme-corp/foo: not fast enough in our case</li>
<li>fork acme-corp/foo: an option but maintaining our own fork would be a heavy burden</li>
<li>use Composer's inline alias feature: our prefered approach</li>
<li>use Composer Patches</li>
</ul>
<h2>Composerr Inline Alias Method</h2>
<p>The <a href="https://getcomposer.org/doc/articles/aliases.md#require-inline-alias">Inline Alias</a> feature in Composer was the simplest and most effective solution.</p>
<p>It allows for specifying a different version of a package as if it were another.
This method is particularly useful when needing to upgrade a dependency to a newer, more secure version than what is specified by another package.</p>
<p>Here’s how it worked for us: we needed to use a secure version <code>4.4.20</code> of <code>symfony/http-client</code> while <code>acme-corp/foo</code> was still dependent on the vulnerable version <code>4.4.10</code>.
In our <code>composer.json</code>, we specified the safe version with an alias to match the version expected by <code>acme-corp/foo</code>. It looked something like this:</p>
<pre><code class="language-json">&quot;require&quot;: {
    &quot;symfony/http-client&quot;: &quot;4.4.20 as 4.4.10&quot;
}
</code></pre>
<p>After updating dependencies with <code>composer update</code>, Composer treated the secure symfony/http-client version 4.4.20 as if it were the vulnerable 4.4.10.
This approach allowed us to quickly mitigate the security risk without waiting for an update from acme-corp/foo.</p>
<p>The beauty of this solution lies in its simplicity and immediacy. It ensures that your project remains secure while minimizing disruption.
Watch out though: major version changes or significant updates could introduce compatibility issues.</p>
<p>Once acme-corp/foo catches up, we can then drop the symfony/http-client from our composer.json.</p>
<h2>Composer Patches</h2>
<p>Another method we looked at was using <a href="https://docs.cweagans.net/composer-patches/">Composer Patches</a>.
This involves applying a patch to the package directly in the vendor directory, using a plugin like <a href="https://github.com/cweagans/composer-patches"><code>cweagans/composer-patches</code></a>.
This approach is useful when specific changes or fixes are needed in a dependency but is harder to maintain than an inline alias.</p>
<p>To get composer patches working, you require the composer-patches plugin, then provide a path to your own patch in the <code>extras</code> section of <code>composer.json</code>, something like this:</p>
<pre><code class="language-json">&quot;require&quot;: {
    &quot;symfony/http-client&quot;: &quot;4.4.10&quot;,
    &quot;cweagans/composer-patches&quot;: &quot;^1.7&quot;
},
&quot;extra&quot;: {
    &quot;patches&quot;: {
        &quot;symfony/http-client&quot;: {
            &quot;Security fix for HTTP Client&quot;: &quot;path/to/http-client-security-fix.patch&quot;
        }
    }
}

</code></pre>
<p>Although we didn’t opt for this method, it's a viable alternative for situations where an inline alias might not be appropriate and is a useful feature to be aware of.</p>
<h2>Conclusion</h2>
<p>This was a reminder of how our own security is so dependent on our vendors' security practices and reinforced the importance of being able to respond quickly to security vulnerabilities, especially when dependent on third-party packages.</p>
<p>There's often lots of hidden features in package management tools like Composer. It's worth reading the <a href="https://getcomposer.org/doc/">documentation</a> to find out what else it can do.
It turned out that the Inline Alias method was a much simpler way to mitigate the security risk, without the overhead of maintaining a fork or relying on external maintainers.</p>

        </section>

        <hr>

        <footer>
            &copy; Dave Hulbert<p><a href="/">Home</a> | <a href="https://github.com/dave1010/til/blob/main/./php/composer-aliases-and-patching.md" target="_blank">Edit this page on GitHub</a></p></footer>
    </main>
  </body>
</html>
